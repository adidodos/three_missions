rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    function isDeveloper() {
      return isSignedIn() &&
        request.auth.token.email == 'ddoddoyun1213@gmail.com';
    }

    function isGlobalAdmin() {
      return isDeveloper() ||
        (isSignedIn() &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)));
    }

    // Get member document for current user in a crew
    function getMember(crewId) {
      return get(/databases/$(database)/documents/crews/$(crewId)/members/$(request.auth.uid));
    }

    // Check if user is a member of the crew
    function isMember(crewId) {
      return isSignedIn() && exists(/databases/$(database)/documents/crews/$(crewId)/members/$(request.auth.uid));
    }

    // Check if user is admin (OWNER or ADMIN) of the crew
    function isAdmin(crewId) {
      return isMember(crewId) && getMember(crewId).data.role in ['OWNER', 'ADMIN'];
    }

    // Check if user is the crew owner
    function isCrewOwner(crewId) {
      return isMember(crewId) && getMember(crewId).data.role == 'OWNER';
    }

    // ==================
    // Collection group: members (for querying user's crews)
    // ==================
    match /{path=**}/members/{memberId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    // ==================
    // Collection group: joinRequests (for account deletion)
    // ==================
    match /{path=**}/joinRequests/{requestId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    // ==================
    // /users/{uid}
    // ==================
    match /users/{uid} {
      // Users can read/write their own profile
      allow read: if isSignedIn();
      allow create, update: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    // ==================
    // /admins/{uid}
    // ==================
    match /admins/{uid} {
      // A user can only read their own admin marker document.
      allow read: if isOwner(uid);
      // Developer can create their own admin document (bootstrap).
      allow create: if isGlobalAdmin() || (isDeveloper() && isOwner(uid));
      // Only admins can manage admin documents.
      allow update, delete: if isGlobalAdmin();
    }

    // ==================
    // /inquiries/{docId}
    // ==================
    match /inquiries/{docId} {
      // Users can create inquiries
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;

      // Users can read their own inquiries, admins can read all
      allow read: if isSignedIn() && (resource.data.uid == request.auth.uid || isGlobalAdmin());

      // Only admins can update (answer)
      allow update: if isGlobalAdmin();
      allow delete: if isSignedIn() && (resource.data.uid == request.auth.uid || isGlobalAdmin());
    }

    // ==================
    // /wall_posts/{crewId}
    // 크루 홍보 담벼락 글 (crewId = 문서 ID, 크루당 1개)
    // ==================
    match /wall_posts/{crewId} {
      // 로그인한 모든 사용자가 읽기 가능
      allow read: if isSignedIn();

      // 크루장(OWNER)만 작성 가능
      // ownerUid는 반드시 요청자 uid와 일치해야 함
      allow create: if isCrewOwner(crewId)
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.crewId == crewId;

      // 크루장만 수정 가능
      // crewId, ownerUid는 변경 불가
      allow update: if isCrewOwner(crewId)
        && resource.data.ownerUid == request.auth.uid
        && request.resource.data.ownerUid == resource.data.ownerUid
        && request.resource.data.crewId == resource.data.crewId;

      // 크루장 또는 전역 관리자만 삭제 가능
      allow delete: if isCrewOwner(crewId) || isGlobalAdmin();
    }

    // ==================
    // /crews/{crewId}
    // ==================
    match /crews/{crewId} {
      // Any signed-in user can read crews (for search)
      allow read: if isSignedIn();

      // Any signed-in user can create a crew
      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;

      // Only owner can update/delete crew
      allow update, delete: if isCrewOwner(crewId);

      // ==================
      // /crews/{crewId}/members/{uid}
      // ==================
      match /members/{uid} {
        // Members can read other members, users can read own membership (collectionGroup)
        allow read: if isMember(crewId) || (isSignedIn() && resource.data.uid == request.auth.uid);

        // Crew owner can create their own initial member doc
        // Admins can create other members
        allow create: if isAdmin(crewId)
          || (isSignedIn()
              && uid == request.auth.uid
              && getAfter(/databases/$(database)/documents/crews/$(crewId)).data.ownerUid == request.auth.uid
              && request.resource.data.role == 'OWNER');
        // Admins can update non-owner members (role changes, bans, etc.)
        // Users can update their own member doc (profile sync) but cannot change role/status
        // Owner can step down to MEMBER atomically as part of an ownership transfer batch
        allow update: if (isAdmin(crewId) && resource.data.role != 'OWNER')
          || (isSignedIn() && uid == request.auth.uid
              && request.resource.data.role == resource.data.role
              && request.resource.data.status == resource.data.status)
          || (isSignedIn() && uid == request.auth.uid
              && resource.data.role == 'OWNER'
              && request.resource.data.role == 'MEMBER'
              && request.resource.data.status == resource.data.status
              && getAfter(/databases/$(database)/documents/crews/$(crewId)).data.ownerUid != request.auth.uid);
        // Users can delete their own member doc (leave crew / account deletion)
        // Admins can delete non-owner members (kick)
        allow delete: if (isSignedIn() && uid == request.auth.uid)
          || (isAdmin(crewId) && resource.data.role != 'OWNER');
      }

      // ==================
      // /crews/{crewId}/joinRequests/{uid}
      // ==================
      match /joinRequests/{uid} {
        // User can read their own request
        allow read: if isOwner(uid);

        // Admins can read all requests
        allow read: if isAdmin(crewId);

        // User can create their own request
        allow create: if isOwner(uid) && request.resource.data.status == 'PENDING';

        // Admins can update requests (approve/reject)
        allow update: if isAdmin(crewId);

        // User can delete their own request (for account deletion)
        allow delete: if isOwner(uid);
      }

      // ==================
      // /crews/{crewId}/workouts/{workoutId}
      // ==================
      match /workouts/{workoutId} {
        // Members can read all workouts (for crew table)
        allow read: if isMember(crewId);

        // Users can only create/update/delete their own workouts
        // workoutId format: {uid}_{dateKey}
        allow create: if isMember(crewId)
          && request.resource.data.uid == request.auth.uid
          && workoutId.matches(request.auth.uid + '_[0-9]{4}-[0-9]{2}-[0-9]{2}');

        allow update: if isMember(crewId)
          && resource.data.uid == request.auth.uid;

        allow delete: if isMember(crewId)
          && resource.data.uid == request.auth.uid;
      }
    }
  }
}
